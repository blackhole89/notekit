From b7018a6c7db5cf64197b878b15520a2130957632 Mon Sep 17 00:00:00 2001
From: sp1rit <sp1rit@disroot.org>
Date: Tue, 4 May 2021 21:58:31 +0200
Subject: [PATCH] various changes that are required to build notekit with mingw

Signed-off-by: sp1rit <sp1rit@disroot.org>
---
 drawing.cpp            | 4 ++--
 imagewidgets.cpp       | 4 ++--
 main.cpp               | 5 +++--
 mainwindow.cpp         | 3 ++-
 notebook_highlight.hpp | 2 +-
 5 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/drawing.cpp b/drawing.cpp
index e08870b..33b8821 100644
--- a/drawing.cpp
+++ b/drawing.cpp
@@ -420,13 +420,13 @@ void CBoundDrawing::Unselect() {
 
 void CBoundDrawing::on_unrealize()
 {
-	printf("unrealize event on %08lX\n", (unsigned long) this);
+	printf("unrealize event on %08llX\n", (uintptr_t) this);
 	//get_parent()->remove(*this);
 }
 
 void CBoundDrawing::destroy_notify_()
 {
-	printf("destroy event on %08lX\n", (unsigned long) this);
+	printf("destroy event on %08llX\n", (uintptr_t) this);
 	strokes.~vector<CStroke>();
 }
 
diff --git a/imagewidgets.cpp b/imagewidgets.cpp
index 108a415..c919074 100644
--- a/imagewidgets.cpp
+++ b/imagewidgets.cpp
@@ -13,12 +13,12 @@ CImageWidget::CImageWidget(Glib::RefPtr<Gdk::Window> wnd) : Glib::ObjectBase("CI
 
 void CImageWidget::on_unrealize()
 {
-	printf("unrealize event on CImageWidget %08lX\n", (unsigned long) this);
+	printf("unrealize event on CImageWidget %08llX\n", (uintptr_t) this);
 }
 
 void CImageWidget::destroy_notify_()
 {
-	printf("destroy event on CImageWidget %08lX\n", (unsigned long) this);
+	printf("destroy event on CImageWidget %08llX\n", (uintptr_t) this);
 }
 
 void CImageWidget::SetSize(int x, int y)
diff --git a/main.cpp b/main.cpp
index c97889e..495b667 100644
--- a/main.cpp
+++ b/main.cpp
@@ -1,13 +1,14 @@
 #include "mainwindow.h"
 #include <gtkmm/application.h>
+#include <windows.h>
 
 CMainWindow *mainwindow;
 
-int main (int argc, char *argv[])
+int WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)
 {
 	Gsv::init();
 	
-	Glib::RefPtr<Gtk::Application> app = Gtk::Application::create(argc, argv, "com.github.blackhole89.notekit");
+	Glib::RefPtr<Gtk::Application> app = Gtk::Application::create("com.github.blackhole89.notekit");
 	
 	app->signal_activate().connect( [app]() {
 			auto mainwindow=new CMainWindow(app);
diff --git a/mainwindow.cpp b/mainwindow.cpp
index b0008e8..f179803 100644
--- a/mainwindow.cpp
+++ b/mainwindow.cpp
@@ -5,6 +5,7 @@
 #include <iostream>
 #include <fontconfig/fontconfig.h>
 #include <locale.h>
+#include <windows.h>
 
 #include <stdlib.h>
 #ifdef MIGRATE_LEGACY_SETTINGS
@@ -482,7 +483,7 @@ void CMainWindow::FetchAndSave()
 	fclose(fl);
 	
 	/* atomic replace */
-	rename(tmp_filename.c_str(), filename.c_str());
+	MoveFileExA(tmp_filename.c_str(), filename.c_str(), MOVEFILE_REPLACE_EXISTING | MOVEFILE_WRITE_THROUGH);
 }
 
 void CMainWindow::FetchAndExport()
diff --git a/notebook_highlight.hpp b/notebook_highlight.hpp
index fd7330d..a0007df 100644
--- a/notebook_highlight.hpp
+++ b/notebook_highlight.hpp
@@ -1,6 +1,6 @@
 std::string CNotebook::GetHighlightProxyDir()
 {
-	if(mkdir("/tmp/notekit.gsv",0777) && errno!=EEXIST) {
+	if(mkdir("/tmp/notekit.gsv") && errno!=EEXIST) {
 		printf("Failed to create a temporary directory for syntax highlighting data.\n");
 		return "";
 	}
-- 
2.38.1

